# ğŸ Snake Game + Chatroom - OS Final Project

å¤šäººè²ªé£Ÿè›‡éŠæˆ² + å³æ™‚èŠå¤©å®¤ï¼Œç¬¦åˆä½œæ¥­ç³»çµ±æœŸæœ«å°ˆæ¡ˆæ‰€æœ‰è¦æ±‚ã€‚

## ğŸ“‹ èª²ç¨‹è¦æ±‚ Checklist

| è¦æ±‚ | ç‹€æ…‹ | å¯¦ä½œæ–¹å¼ |
|------|------|----------|
| **Server: Multi-process** | âœ… | Prefork Workers + Game Loop Process |
| **IPC: å…±äº«è¨˜æ†¶é«”** | âœ… | System V Shared Memory (shmget/shmat) |
| **Client: Multi-threaded** | âœ… | Input + Receiver + Heartbeat ä¸‰å€‹åŸ·è¡Œç·’ |
| **100+ ä½µç™¼å£“åŠ›æ¸¬è©¦** | âœ… | `./client -s 100` |
| **å»¶é²/ååé‡çµ±è¨ˆ** | âœ… | Avg Latency (Î¼s) + Throughput (req/sec) |
| **Custom Protocol** | âœ… | 8-byte header [Len\|OpCode\|Checksum] |
| **Security: Checksum** | âœ… | 16-bit checksum é©—è­‰ |
| **Security: åŠ å¯†** | âœ… | XOR cipher (key: 0x5A) |
| **Reliability: Heartbeat** | âœ… | Client æ¯ 3 ç§’ç™¼é€å¿ƒè·³ |
| **Reliability: Timeout** | âœ… | Server è¿½è¹¤é€£ç·šç‹€æ…‹ |
| **Modularity: éœæ…‹å‡½å¼åº«** | âœ… | libproto.a |
| **README æ–‡ä»¶** | âœ… | æœ¬æ–‡ä»¶ |

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹

### Server æ¶æ§‹ (Multi-Process + Shared Memory)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚         Shared Memory (IPC)         â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                    â”‚  â”‚ GameState                       â”‚â”‚
                    â”‚  â”‚ â”œâ”€â”€ map[50][50]                 â”‚â”‚
                    â”‚  â”‚ â”œâ”€â”€ players[100]                â”‚â”‚
                    â”‚  â”‚ â”œâ”€â”€ foods[20]                   â”‚â”‚
                    â”‚  â”‚ â”œâ”€â”€ chat_history[50]            â”‚â”‚
                    â”‚  â”‚ â””â”€â”€ pthread_mutex (PROCESS_SHARED)â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–²           â–²
                              â”‚           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                   â”‚   â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Game Loop Processâ”‚ â”‚ Worker Process â”‚ â”‚ Worker Process Ã— N   â”‚
    â”‚  (fork)           â”‚ â”‚ (prefork)      â”‚ â”‚ (prefork)            â”‚
    â”‚                   â”‚ â”‚                â”‚ â”‚                      â”‚
    â”‚ â€¢ Move snakes     â”‚ â”‚ â€¢ Accept conn  â”‚ â”‚ â€¢ Handle clients     â”‚
    â”‚ â€¢ Check collision â”‚ â”‚ â€¢ Recv commandsâ”‚ â”‚ â€¢ Send map updates   â”‚
    â”‚ â€¢ Auto respawn    â”‚ â”‚ â€¢ Send updates â”‚ â”‚ â€¢ Broadcast chat     â”‚
    â”‚ â€¢ Rebuild map     â”‚ â”‚ â€¢ Chat relay   â”‚ â”‚                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Client æ¶æ§‹ (Multi-Threaded)

```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    Client Process                    â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ Main Thread â”‚ â”‚ Recv Thread â”‚ â”‚Heartbeat Threadâ”‚ â”‚
    â”‚  â”‚             â”‚ â”‚             â”‚ â”‚               â”‚  â”‚
    â”‚  â”‚ â€¢ ncurses UIâ”‚ â”‚ â€¢ Map updateâ”‚ â”‚ â€¢ Keep-alive  â”‚  â”‚
    â”‚  â”‚ â€¢ Key input â”‚ â”‚ â€¢ Chat recv â”‚ â”‚ â€¢ Every 3 sec â”‚  â”‚
    â”‚  â”‚ â€¢ Send move â”‚ â”‚ â€¢ Scoreboardâ”‚ â”‚               â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¡ Protocol è¦æ ¼

### Packet Header (8 bytes)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Length    â”‚  OpCode    â”‚  Checksum  â”‚
â”‚  (4 bytes) â”‚  (2 bytes) â”‚  (2 bytes) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpCodes

| OpCode | åç¨± | æ–¹å‘ | èªªæ˜ |
|--------|------|------|------|
| 0x0001 | LOGIN_REQ | Câ†’S | ç™»å…¥è«‹æ±‚ |
| 0x0002 | LOGIN_RESP | Sâ†’C | ç™»å…¥å›æ‡‰ |
| 0x0003 | MOVE | Câ†’S | ç§»å‹•æ–¹å‘ |
| 0x0004 | MAP_UPDATE | Sâ†’C | åœ°åœ–æ›´æ–° |
| 0x0005 | CHAT_SEND | Câ†’S | ç™¼é€èŠå¤© |
| 0x0006 | CHAT_RECV | Sâ†’C | æ¥æ”¶èŠå¤© |
| 0x0010 | HEARTBEAT | Câ†’S | å¿ƒè·³åŒ… |
| 0x0011 | HEARTBEAT_ACK | Sâ†’C | å¿ƒè·³å›æ‡‰ |

### å®‰å…¨æ©Ÿåˆ¶

1. **Checksum**: è¨ˆç®— payload æ‰€æœ‰ bytes çš„ç¸½å’Œ (16-bit)
2. **XOR åŠ å¯†**: æ‰€æœ‰ payload ä½¿ç”¨ key=0x5A é€²è¡Œ XOR

```
ç™¼é€æµç¨‹: Raw Data â†’ Calculate Checksum â†’ XOR Encrypt â†’ Send
æ¥æ”¶æµç¨‹: Receive â†’ XOR Decrypt â†’ Verify Checksum â†’ Process
```

## ğŸ”§ ç·¨è­¯èˆ‡åŸ·è¡Œ

### ç·¨è­¯

```bash
# å®‰è£ä¾è³´ (Ubuntu/WSL)
sudo apt install build-essential libncurses-dev

# ç·¨è­¯
make clean && make all
```

### åŸ·è¡Œ

```bash
# Terminal 1: å•Ÿå‹• Server
./server

# Terminal 2: ç©å®¶ 1
./client -n Alice

# Terminal 3: ç©å®¶ 2
./client -n Bob

# å£“åŠ›æ¸¬è©¦ (100 å€‹ AI clients)
./client -s 100
```

### å¦‚æœ Server å´©æ½°

```bash
# æ¸…ç†å…±äº«è¨˜æ†¶é«”
make clean-shm

# æˆ–æ‰‹å‹•æ¸…ç†
ipcrm -M 0x5e5e5e5e
```

## ğŸ® éŠæˆ²æ“ä½œ

| æŒ‰éµ | åŠŸèƒ½ |
|------|------|
| â†‘ â†“ â† â†’ | ç§»å‹•è›‡ |
| Tab | é€²å…¥èŠå¤©æ¨¡å¼ |
| Enter | ç™¼é€è¨Šæ¯ |
| Esc | å–æ¶ˆèŠå¤© |
| Q | é›¢é–‹éŠæˆ² |

## ğŸ¯ éŠæˆ²ç‰¹è‰²

- **å¤šäººé€£ç·š**: æœ€å¤š 100 ä½ç©å®¶åŒæ™‚éŠæˆ²
- **å³æ™‚èŠå¤©**: æ‰€æœ‰ç©å®¶å…±äº«èŠå¤©å®¤
- **è‡ªå‹•å¾©æ´»**: æ­»äº¡å¾Œ 3 ç§’è‡ªå‹•é‡ç”Ÿ
- **å‡ºç”Ÿä¿è­·**: é‡ç”Ÿå¾Œ 3 ç§’ç„¡æ•µ
- **åƒé£Ÿç‰©é•·å¤§**: æ¯åƒä¸€å€‹é£Ÿç‰© +10 åˆ†

## ğŸ“Š å£“åŠ›æ¸¬è©¦è¼¸å‡ºç¯„ä¾‹

```
========================================
  Stress Test - 100 Concurrent Clients
========================================
  Clients:      100
  Connected:    100
  Requests:     5000
  Time:         12.34 sec
  Avg Latency:  2500 us (2.50 ms)
  Throughput:   405.19 req/sec
========================================
```

## ğŸ“ æª”æ¡ˆçµæ§‹

```
SnakeFinal/
â”œâ”€â”€ common.h      # å…±ç”¨å®šç¾© (å¸¸æ•¸ã€çµæ§‹ã€å”å®š)
â”œâ”€â”€ proto.h       # Protocol å‡½å¼å®£å‘Š
â”œâ”€â”€ proto.c       # Protocol å¯¦ä½œ (checksum + XOR)
â”œâ”€â”€ server.c      # Multi-process Server
â”œâ”€â”€ client.c      # Multi-threaded Client
â”œâ”€â”€ Makefile      # ç·¨è­¯è…³æœ¬
â”œâ”€â”€ README.md     # æœ¬æ–‡ä»¶
â””â”€â”€ libproto.a    # éœæ…‹å‡½å¼åº« (ç·¨è­¯ç”¢ç”Ÿ)
```

## ğŸ‘¥ åœ˜éšŠåˆ†å·¥

| æˆå“¡ | è² è²¬æ¨¡çµ„ |
|------|----------|
| A | Server (Multi-process, Shared Memory, Game Loop) |
| B | Client (Multi-thread, ncurses UI, å£“åŠ›æ¸¬è©¦) |
| C | Protocol (Checksum, XOR åŠ å¯†, å°åŒ…è™•ç†) |
| D | æ•´åˆæ¸¬è©¦ã€æ–‡ä»¶æ’°å¯«ã€Bug ä¿®å¾© |

## ğŸ“š æŠ€è¡“ç´°ç¯€

### ç‚ºä»€éº¼é¸æ“‡ Prefork + Shared Memory?

1. **Prefork (é å…ˆ fork)**
   - é¿å… accept æ™‚æ‰ fork çš„å»¶é²
   - Worker é€²ç¨‹é‡è¤‡ä½¿ç”¨ï¼Œæ•ˆç‡é«˜
   - ç¬¦åˆèª²ç¨‹ã€ŒMulti-processã€è¦æ±‚

2. **System V Shared Memory**
   - æ‰€æœ‰ Worker å…±äº«åŒä¸€ä»½éŠæˆ²ç‹€æ…‹
   - ä½¿ç”¨ `PTHREAD_PROCESS_SHARED` mutex åŒæ­¥
   - ç¬¦åˆèª²ç¨‹ã€ŒIPCã€è¦æ±‚

3. **ç¨ç«‹ Game Loop Process**
   - å›ºå®š 100ms tick rate æ›´æ–°éŠæˆ²
   - ä¸å— client I/O å½±éŸ¿
   - ç¢ºä¿éŠæˆ²é‚è¼¯ä¸€è‡´æ€§

### åŒæ­¥æ©Ÿåˆ¶

```c
// Shared Memory ä¸­çš„ mutex
pthread_mutexattr_t attr;
pthread_mutexattr_setpshared(&attr, PTHREAD_PROCESS_SHARED);
pthread_mutex_init(&g_state->lock, &attr);

// å­˜å–å…±äº«ç‹€æ…‹æ™‚åŠ é–
pthread_mutex_lock(&g_state->lock);
// ... è®€å¯« game state ...
pthread_mutex_unlock(&g_state->lock);
```

## ğŸ“ License

MIT License
